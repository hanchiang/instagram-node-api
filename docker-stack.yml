version: '3.1'

# a stack-file version of this for running in Swarm services

services:
  node:
    # reminder, don't use latest tag in production, use versions created by CI/CD
    image: bretfisher/node-docker-good-defaults:latest
    ports:
      - "80:3000"
    environment:
      - NODE_ENV=production
      # - POSTGRES_USER_FILE=/run/secrets/postgres_user
      # - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
      # - POSTGRES_DB=instagram
      # TODO: hostname
      # - POSTGRES_HOSTNAME=mongo
      # - POSTGRES_PORT=5432
    secrets:
      # - postgres_user
      # - postgres_password
    deploy:
      replicas: 2

  postgres:
    image: postgres:11-alpine
    ports:
      - "5432"
    environment:
      # - POSTGRES_USER_FILE=/run/secrets/postgres_user
      # - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
      # - POSTGRES_DB=instagram
    secrets:
      # - mongo_root
      # - mongo_root_password
    healthcheck:
      test: ["CMD-SHELL", "./postgresql/docker-healthcheck"]
      interval: 5s
      timeout: 5s
      retries: 3

secrets:
  # postgres_user:
  #   external: true
  # postgres_password:
  #   external: true